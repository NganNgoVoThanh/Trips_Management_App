<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Sync Azure AD Users</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 2rem;
      background: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      padding: 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 1rem;
    }
    .warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 4px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      color: #856404;
    }
    .info {
      background: #d1ecf1;
      border: 1px solid #17a2b8;
      border-radius: 4px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      color: #0c5460;
    }
    .success {
      background: #d4edda;
      border: 1px solid #28a745;
      border-radius: 4px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      border: 1px solid #dc3545;
      border-radius: 4px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      color: #721c24;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .danger {
      background: #dc3545;
    }
    .danger:hover {
      background: #c82333;
    }
    pre {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 4px;
      overflow-x: auto;
      margin-top: 1rem;
      font-size: 0.875rem;
      line-height: 1.5;
    }
    .step {
      margin-bottom: 2rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid #dee2e6;
    }
    .step:last-child {
      border-bottom: none;
    }
    .step h2 {
      color: #495057;
      margin-bottom: 0.5rem;
      font-size: 1.25rem;
    }
    .loading {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 0.5rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîÑ Test Sync Azure AD Users</h1>

    <div class="warning">
      <strong>‚ö†Ô∏è Ch√∫ √Ω:</strong> Ch·ªâ ADMIN m·ªõi c√≥ quy·ªÅn sync Azure AD users!
    </div>

    <!-- Step 1: Check Session -->
    <div class="step">
      <h2>B∆∞·ªõc 1: Ki·ªÉm tra Session</h2>
      <button onclick="checkSession()">Check Session</button>
      <div id="sessionResult"></div>
    </div>

    <!-- Step 2: Get Sync Stats -->
    <div class="step">
      <h2>B∆∞·ªõc 2: Xem th√¥ng tin Sync hi·ªán t·∫°i</h2>
      <button onclick="getSyncStats()">Get Sync Stats</button>
      <div id="statsResult"></div>
    </div>

    <!-- Step 3: Sync Azure Users -->
    <div class="step">
      <h2>B∆∞·ªõc 3: Sync Azure AD Users</h2>
      <div class="info">
        <strong>‚ÑπÔ∏è L∆∞u √Ω:</strong> C·∫ßn access token t·ª´ Azure AD. Token s·∫Ω ƒë∆∞·ª£c l·∫•y t·ª± ƒë·ªông t·ª´ session.
      </div>
      <button onclick="syncAzureUsers()" class="danger" id="syncButton">
        üöÄ Start Sync
      </button>
      <div id="syncResult"></div>
    </div>

    <!-- Step 4: Verify Database -->
    <div class="step">
      <h2>B∆∞·ªõc 4: Ki·ªÉm tra Database</h2>
      <button onclick="getSyncStats()">Refresh Stats</button>
      <div class="info">
        Sau khi sync xong, ki·ªÉm tra database b·∫±ng MySQL:
        <pre>SELECT COUNT(*) FROM azure_ad_users_cache;
SELECT * FROM azure_ad_users_cache LIMIT 10;</pre>
      </div>
    </div>
  </div>

  <script>
    let currentSession = null;

    async function checkSession() {
      const result = document.getElementById('sessionResult');
      result.innerHTML = '<div class="info">ƒêang ki·ªÉm tra session...</div>';

      try {
        const response = await fetch('/api/auth/session');
        const session = await response.json();
        currentSession = session;

        if (!session || !session.user) {
          result.innerHTML = `
            <div class="error">
              <strong>‚ùå Ch∆∞a ƒëƒÉng nh·∫≠p!</strong>
              <p>Vui l√≤ng <a href="/" target="_blank">ƒëƒÉng nh·∫≠p</a> tr∆∞·ªõc.</p>
            </div>
          `;
          return;
        }

        const isAdmin = session.user.role === 'admin';

        result.innerHTML = `
          <div class="${isAdmin ? 'success' : 'error'}">
            <strong>${isAdmin ? '‚úÖ' : '‚ùå'} Session Info:</strong>
            <pre>${JSON.stringify(session.user, null, 2)}</pre>
            ${!isAdmin ? '<p><strong>B·∫°n kh√¥ng ph·∫£i admin!</strong> Ch·ªâ admin m·ªõi c√≥ quy·ªÅn sync.</p>' : ''}
          </div>
        `;
      } catch (error) {
        result.innerHTML = `
          <div class="error">
            <strong>‚ùå L·ªói:</strong> ${error.message}
          </div>
        `;
      }
    }

    async function getSyncStats() {
      const result = document.getElementById('statsResult');
      result.innerHTML = '<div class="info">ƒêang l·∫•y th√¥ng tin...</div>';

      try {
        const response = await fetch('/api/admin/sync-azure');
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to get stats');
        }

        result.innerHTML = `
          <div class="success">
            <strong>üìä Sync Stats:</strong>
            <ul style="margin-top: 0.5rem; margin-left: 1.5rem;">
              <li><strong>Total Users:</strong> ${data.totalUsers || 0}</li>
              <li><strong>Active Users:</strong> ${data.activeUsers || 0}</li>
              <li><strong>Last Sync:</strong> ${data.lastSyncTime ? new Date(data.lastSyncTime).toLocaleString('vi-VN') : 'Ch∆∞a sync l·∫ßn n√†o'}</li>
              <li><strong>First Sync:</strong> ${data.firstSyncTime ? new Date(data.firstSyncTime).toLocaleString('vi-VN') : 'N/A'}</li>
            </ul>
          </div>
        `;
      } catch (error) {
        result.innerHTML = `
          <div class="error">
            <strong>‚ùå L·ªói:</strong> ${error.message}
          </div>
        `;
      }
    }

    async function syncAzureUsers() {
      const result = document.getElementById('syncResult');
      const button = document.getElementById('syncButton');

      if (!currentSession || !currentSession.user) {
        result.innerHTML = `
          <div class="error">
            <strong>‚ùå L·ªói:</strong> Vui l√≤ng check session tr∆∞·ªõc!
          </div>
        `;
        return;
      }

      if (currentSession.user.role !== 'admin') {
        result.innerHTML = `
          <div class="error">
            <strong>‚ùå L·ªói:</strong> Ch·ªâ admin m·ªõi c√≥ quy·ªÅn sync!
          </div>
        `;
        return;
      }

      button.disabled = true;
      result.innerHTML = '<div class="info">üîÑ ƒêang sync t·ª´ Azure AD... (c√≥ th·ªÉ m·∫•t v√†i ph√∫t)<span class="loading"></span></div>';

      try {
        // G·ªçi server-side endpoint - kh√¥ng c·∫ßn truy·ªÅn token
        const response = await fetch('/api/admin/sync-azure', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || data.details || 'Sync failed');
        }

        result.innerHTML = `
          <div class="success">
            <strong>‚úÖ Sync th√†nh c√¥ng!</strong>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          </div>
        `;

        // Auto refresh stats
        setTimeout(getSyncStats, 1000);
      } catch (error) {
        result.innerHTML = `
          <div class="error">
            <strong>‚ùå L·ªói khi sync:</strong>
            <p>${error.message}</p>
          </div>
        `;
      } finally {
        button.disabled = false;
      }
    }

    // Auto check session on load
    window.addEventListener('load', checkSession);
  </script>
</body>
</html>
